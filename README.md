# AstrBot 错误/空值重试插件 (Intelligent Retry) - 截断版

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

一个为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的简化重试插件，专门解决与大语言模型（LLM）交互时常见的不稳定问题（如空回复、网关错误等）。当 LLM 响应为空或出错时，会自动检测并进行重试，减少"无响应"或错误提示。

当前版本：2.8.1 (截断版)

## ✨ 功能特性

- **自动重试**：在最终装饰阶段介入，直接替换结果，不打断事件流程。
- **智能检测**：
  1. 最终回复为空时自动重试；
  2. 文本包含错误关键词（如"请求失败""api 返回的内容为空"等）时自动重试。
- **基本上下文保持**：重试时保持基本的对话上下文，确保对话连贯性。
- **固定重试间隔**：使用固定的重试延迟，简单可靠。
- **失败兜底**：所有重试失败后返回可配置的兜底提示，避免"无响应"。

## 🔧 截断版说明

此版本移除了原版本的高级功能，专注于核心重试逻辑：

**移除的功能：**
- 复杂的系统提示词覆盖逻辑
- HTTP状态码解析和过滤
- 上下文预览调试功能  
- 工具调用检测
- 指数退避重试策略

**保留的核心功能：**
- 基本的空回复和错误关键词检测
- 基本的上下文保持
- 可配置的重试次数和间隔
- 兜底回复机制

## 📦 安装

请在 AstrBot 的插件市场中搜索 `intelligent_retry` 进行安装，或通过以下方式手动安装：

1. 进入 AstrBot 主目录。
2. 打开 `data/plugins` 文件夹。
3. 执行 `git clone https://github.com/muyouzhi6/astrabot_plugin_retry.git`。
4. 重启 AstrBot 或在 WebUI 中重载插件。

## ⚙️ 配置

| 配置项 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| **最大重试次数** | `整数` | 当LLM回复无效时的最大重试次数，设置为0则禁用 | 3 |
| **重试间隔（秒）** | `整数` | 每次重试之间的等待时间 | 2 |
| **触发重试的错误关键词** | `文本` | 包含这些关键词的回复将触发重试，每行一个 | api 返回的内容为空... |
| **兜底回复** | `文本` | 达到最大重试次数仍失败时的友好提示，留空则不发送 | 抱歉，刚才遇到服务波动... |

配置修改后会自动保存并生效。

## 📝 使用方法

插件安装并启用后，会自动在后台工作：

1. **自动检测**：当LLM回复为空或包含配置的错误关键词时，插件自动触发。
2. **智能重试**：保持基本上下文，重新向LLM请求回复。
3. **兜底机制**：如果所有重试都失败，返回友好的兜底提示。

无需手动操作，插件会静默处理所有重试逻辑。

## ❓ 常见问题/注意事项

- 插件只会在检测到回复异常时才触发重试，不会影响正常对话。
- 截断版移除了复杂功能，专注于核心重试逻辑，更加稳定可靠。
- 某些极端情况下，LLM 服务端问题可能无法完全避免，遇到多次失败时会显示兜底提示。
- 所有配置均可通过 WebUI 修改，无需手动编辑 config 文件或改代码。
- 如果插件无效，建议先检查 AstrBot 版本和插件是否正确启用。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进这个插件！

## 📄 开源许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件。

## ✍️ 作者

- **木有知 & 长安某** - *开发者* - [GitHub](https://github.com/muyouzhi6)

感谢所有为此项目做出贡献的人！